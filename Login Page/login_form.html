<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login Page</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="login-container">
      <form action="" id="loginForm" novalidate>
        <h1><b>Login To Your Account</b></h1>

        <div class="input-group">
          <label for="username">Username</label>
          <input type="text" id="username" required placeholder="Username" />
          <span class="error-message">Username is required.</span>
        </div>

        <div class="input-group">
          <label for="password">Password</label>
          <input
            type="password"
            id="password"
            required
            minlength="8"
            maxlength="16"
            placeholder="Password"
          />
          <span class="error-message">Password is required.</span>
        </div>

        <div class="auth-type">
          <label><b>Authentication Type:</b></label>
          <br />
          <input
            type="radio"
            name="auth_type"
            value="user"
            required
            id="auth_user"
            checked
          />
          <label for="auth_user">As User</label>

          <input
            type="radio"
            name="auth_type"
            value="company"
            id="auth_company"
          />
          <label for="auth_company">As Company</label>
          <span
            class="error-message"
            id="auth-type-error"
            style="display: block; color: red; font-size: 0.8em"
          ></span>
        </div>
        <br />
        <input type="submit" value="Login" />
        <br /><br />
        <div class="register-link">
          <a
            href="register_form.html"
            style="
              background: none;
              border: none;
              color: #000000;
              font-size: 12px;
              text-transform: none;
              margin: 0;
              padding: 0;
            "
            >Register new account</a
          >
        </div>
      </form>
    </div>
    <script>
      const form = document.getElementById("loginForm");
      const usernameInput = document.getElementById("username");
      const passwordInput = document.getElementById("password");

      function setError(input, message) {
        const inputGroup = input.parentElement;
        const errorDisplay = inputGroup.querySelector(".error-message");

        if (message) {
          errorDisplay.innerText = message;
        }

        inputGroup.classList.add("error");
        inputGroup.classList.remove("success");
      }

      function setSuccess(input) {
        const inputGroup = input.parentElement;
        inputGroup.classList.remove("error");
        inputGroup.classList.add("success");
      }

      function validateInput(input) {
        const value = input.value.trim();
        let isValid = true;

        if (input === usernameInput) {
          if (value === "") {
            setError(input, "Username is required");
            isValid = false;
          } else {
            setSuccess(input);
          }
        } else if (input === passwordInput) {
          if (value === "") {
            setError(input, "Password is required");
            isValid = false;
          } else {
            setSuccess(input);
          }
        }

        return isValid;
      }

      // Add event listeners
      [usernameInput, passwordInput].forEach((input) => {
        input.addEventListener("input", () => validateInput(input));
        input.addEventListener("blur", () => validateInput(input));
      });

      // ========================================
      // FORM SUBMISSION HANDLER
      // This runs when the user clicks "Login"
      // ========================================
      form.addEventListener("submit", function (e) {
        // Prevent the form from submitting to a server (we're using localStorage)
        e.preventDefault();

        // Track whether all validation passed
        let isFormValid = true;

        // STEP 1: Validate username and password fields
        [usernameInput, passwordInput].forEach((input) => {
          if (!validateInput(input)) {
            isFormValid = false;
          }
        });

        // STEP 2: Check if user selected "As User" or "As Company"
        const authTypeInputs = document.getElementsByName("auth_type");
        let authTypeSelected = false;
        let selectedAuthType = "";

        // Loop through radio buttons to find which one is checked
        for (let i = 0; i < authTypeInputs.length; i++) {
          if (authTypeInputs[i].checked) {
            authTypeSelected = true;
            selectedAuthType = authTypeInputs[i].value;
            break;
          }
        }

        // Show error if no authentication type selected
        const authError = document.getElementById("auth-type-error");
        if (!authTypeSelected) {
          authError.innerText =
            "‚ö†Ô∏è Please select how you want to login (User or Company)";
          isFormValid = false;
        } else {
          authError.innerText = "";
        }

        // STEP 3: If all validation passed, try to log in
        if (isFormValid) {
          // ==============================================
          // LOGIN PROCESS WITH LOCALSTORAGE
          // ==============================================

          // Get the list of registered users from browser storage
          const storedUsersString = localStorage.getItem("users");

          // Check if anyone has registered yet
          if (!storedUsersString) {
            alert(
              "üëã No registered users found!\n\nPlease create an account first.",
            );
            window.location.href = "register_form.html";
            return;
          }

          // Convert the stored JSON string back into a JavaScript array
          const users = JSON.parse(storedUsersString);

          // Get what the user typed
          const enteredUsername = usernameInput.value.trim();
          const enteredPassword = passwordInput.value;

          // Search for a user with matching username AND password
          const matchedUser = users.find(
            (user) =>
              user.username === enteredUsername &&
              user.password === enteredPassword,
          );

          // CHECK RESULTS: Did we find a matching user?
          if (matchedUser) {
            // ‚úÖ SUCCESS! Username and password match!
            console.log("‚úÖ Login successful for user:", matchedUser);

            // Save login session information
            localStorage.setItem("isLoggedIn", "true");
            localStorage.setItem("currentUser", JSON.stringify(matchedUser));
            localStorage.setItem("authType", selectedAuthType);
            localStorage.setItem("loginTime", new Date().toISOString());

            // Show personalized welcome message
            alert(
              `üéâ Login Successful!\n\nWelcome back, ${matchedUser.name}!\n\nAccount Type: ${selectedAuthType.toUpperCase()}`,
            );

            // Redirect to homepage
            window.location.href = "homepage.html";
          } else {
            // ‚ùå FAILED! Either username or password is wrong

            // Let's check which one is the problem
            const userExists = users.find(
              (user) => user.username === enteredUsername,
            );

            if (userExists) {
              // Username exists, so password must be wrong
              alert(
                "üîí Incorrect Password!\n\nPlease check your password and try again.",
              );
              setError(passwordInput, "Wrong password");
            } else {
              // Username doesn't exist
              alert(
                "‚ùå Username Not Found!\n\nThis username doesn't exist. Please check your username or register a new account.",
              );
              setError(usernameInput, "Username doesn't exist");
            }
          }

          // ==============================================
          // END OF LOGIN PROCESS
          // ==============================================
        }
      });
    </script>
  </body>
</html>
